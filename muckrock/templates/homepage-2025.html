{% extends 'base.html' %}

{% load humanize %}
{% load static %}
{% load foia_tags %}
{% load news_tags %}
{% load tags %}
{% load thumbnail %}
{% load cache %}

{% block scripts %}
<script>
  function initializeTabSwitcher() {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');
      const tabViewers = document.querySelectorAll('.tab-viewer');
      let isUserScrolling = false;
      let isTabViewerScrolling = false;
      let tabViewerScrollTimeout = null;

      function updateActiveTab(targetTab) {
          // Get target element, container, and all its tabs
          const targetTabElement = document.querySelector(`[data-tab="${targetTab}"]`);
          const targetTabContainer = targetTabElement ? targetTabElement.closest('.tabs') : null;
          const targetTabContainerTabs = targetTabContainer ? targetTabContainer.querySelectorAll('.tab') : [];
          const targetTabContainerContent = targetTabContainer ? targetTabContainer.querySelectorAll('.tab-content') : [];
          
          // Remove active class from all tabs and contents in container
          targetTabContainerTabs.forEach(t => t.classList.remove('active'));
          targetTabContainerContent.forEach(c => c.classList.remove('active'));

          // Add active class to target tab
          if (targetTabElement) {
              targetTabElement.classList.add('active');
          }

          // Scroll the active tab into view horizontally if needed
          if (targetTabElement && typeof targetTabElement.scrollIntoView === 'function') {
            targetTabElement.scrollIntoView({
              behavior: 'smooth',
              inline: 'center',
              block: 'nearest'
            });
          }

          // Add active class to corresponding content
          const targetContent = document.getElementById(targetTab);
          if (targetContent) {
              targetContent.classList.add('active');
          }
      }

      function switchToTab(targetTab) {
          updateActiveTab(targetTab);

          // Scroll the content into view
          const targetContent = document.getElementById(targetTab);
          if (targetContent) {
              targetContent.scrollIntoView({
                  behavior: 'smooth',
                  block: 'nearest'
              });
          }
      }

      // Set up Intersection Observer to detect visible billboards
      function initializeScrollSync() {
          const observerOptions = {
              root: null,
              rootMargin: '0px 0px 0px -20%', // Trigger when billboard is 20% from the left edge
              threshold: 0.1
          };

          const observer = new IntersectionObserver((entries) => {
              // Only trigger if user is scrolling the tab-viewer,
              // not the page, and not during programmatic tab switch
              if (!isTabViewerScrolling || isUserScrolling) return;

              entries.forEach(entry => {
                  if (entry.isIntersecting) {
                      const contentId = entry.target.id;
                      updateActiveTab(contentId);
                  }
              });
          }, observerOptions);

          // Observe all contents
          contents.forEach(content => {
              if (content.id) {
                  observer.observe(content);
              }
          });
      }

      // Listen for scroll events on all .tab-viewer elements
      tabViewers.forEach(tabViewer => {
          tabViewer.addEventListener('scroll', function() {
              isTabViewerScrolling = true;
              if (tabViewerScrollTimeout) {
                  clearTimeout(tabViewerScrollTimeout);
              }
              tabViewerScrollTimeout = setTimeout(() => {
                  isTabViewerScrolling = false;
              }, 150);
          });
      });

      // Attach click handlers to tabs
      tabs.forEach(tab => {
          tab.addEventListener('click', function() {
              const targetTab = this.getAttribute('data-tab');

              // Set flag to prevent scroll sync during programmatic scrolling
              isUserScrolling = true;
              switchToTab(targetTab);

              // Reset flag after scroll animation completes
              setTimeout(() => {
                  isUserScrolling = false;
              }, 800); // Slightly longer than typical smooth scroll duration
          });
      });

      // Initialize scroll synchronization
      initializeScrollSync();

      // Return API for external use
      return {
          switchToTab: switchToTab
      };
  }

  document.addEventListener('DOMContentLoaded', function() {
      initializeTabSwitcher();
  });
</script>
{% endblock %}

{% block content %}
<div class="homepage-2025">
  <div class="homepage-section" id="about-us">
    <div class="text-column">
      <h2>{{homepage.about_heading}}</h2>
      <p>{{homepage.about_paragraph}}</p>
      <ul class="actions-list">
        <li><a href="#footer-donation" class="ghost button red">{% include 'lib/component/icon/donate.svg' %}Donate</a></li>
        <li><a href="/store/" class="ghost button primary">{% include 'lib/component/icon/merch.svg' %}Shop merch</a></li>
        <li><a href="/newsletters/" class="ghost button primary">{% include 'lib/component/icon/mail.svg' %}Subscribe to the newsletter</a></li>
        <li><a href="/about/" class="ghost button primary">Learn more about our mission and impact</a></li>
      </ul>
    </div>
  </div>
  <div class="tab-container" id="products">
    {% if not user.is_authenticated %}
    <header class="account" id="muckrock-account">
      <h3>Access tools from MuckRock and our partners with a single account</h3>
      <div class="account-actions">
        <a href="{% url 'accounts-signup' %}" class="primary button">Sign up</a>
        <a href="{% url 'acct-login' %}" class="primary ghost button">Sign in</a>
      </div>
    </header>
    {% endif %}
    <ul class="tabs">
      <li class="tab active" data-tab="muckrock-requests" title="MuckRock Requests">{% include 'lib/component/logo/muckrock-requests.svg' %}</li>
      <li class="tab" data-tab="documentcloud" title="DocumentCloud">{% include 'lib/component/logo/documentcloud.svg' %}</li>
      <li class="tab" data-tab="data-liberation-project" title="Data Liberation Project">{% include 'lib/component/logo/data-liberation-project.svg' %}</li>
    </ul>
    <div class="tab-viewer">
      <div class="tab-content product active" data-tab="muckrock-requests" id="muckrock-requests" style="background-image: url('{% static 'img/homepage/muckrock-requests.jpg' %}');">
        <div class="product-content">
          <div class="product-heading">
            <h3>File, track, and share public records requests</h3>
          </div>
          <div class="product-main">
            <div class="product-actions">
              <a href="{% url 'foia-create' %}" class="primary button">{% include 'lib/component/icon/plus.svg' %}File a request</a>
              <a href="{% url 'foia-list' %}" class="primary ghost button">{% include 'lib/component/icon/search-octicon.svg' %}Search requests</a>
              <a href="https://help.muckrock.com/How-MuckRock-Works-19ef889269638140b169c8224a4c7c05" target="_blank" class="primary ghost button">{% include 'lib/component/icon/book.svg' %}Learn how it works</a>
            </div>
            <div class="product-stats">
              <div class="stat">
                <span class="number">{{ foia_stats.request_count|intcomma }}</span>
                <span class="label">filed requests</span>
              </div>
              <div class="stat">
                <span class="number">{{ foia_stats.agency_count|intcomma }}</span>
                <span class="label">agencies</span>
              </div>
              <div class="stat">
                <span class="number">{{ foia_stats.completed_count|intcomma }}</span>
                <span class="label">fulfilled requests</span>
              </div>
              <div class="stat">
                <span class="number">{{ foia_stats.page_count|intcomma }}</span>
                <span class="label">pages released</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-content product" data-tab="documentcloud" id="documentcloud" style="background-image: url('{% static 'img/homepage/documentcloud.jpg' %}');">
        <div class="product-content">
          <div class="product-heading">
            <h3>Analyze, annotate and publish primary source documents</h3>
          </div>
          <div class="product-main">
            <div class="product-actions">
              <a href="https://www.documentcloud.org/upload/" class="primary button">{% include 'lib/component/icon/plus.svg' %}Upload a document</a>
              <a href="https://www.documentcloud.org/documents/" class="primary ghost button">{% include 'lib/component/icon/search-octicon.svg' %}Search public documents</a>
              <a href="https://help.muckrock.com/DocumentCloud-19ef8892696381ee8fc4de8d62aa4704?pvs=74" target="_blank" class="primary ghost button">{% include 'lib/component/icon/book.svg' %}Learn how it works</a>
            </div>
            <div class="product-stats">
              <div class="stat">
                <span class="number">{{ product_stats.documentcloud.documents|intcomma }}</span>
                <span class="label">public documents</span>
              </div>
              <div class="stat">
                <span class="number">{{ product_stats.documentcloud.pages|intcomma }}</span>
                <span class="label">public pages</span>
              </div>
              <div class="stat">
                <span class="number">{{ product_stats.documentcloud.notes|intcomma }}</span>
                <span class="label">public notes</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-content product" data-tab="data-liberation-project" id="data-liberation-project" style="background-image: url('{% static 'img/homepage/data-liberation-project.jpg' %}');">
        <div class="product-content">
          <div class="product-heading">
            <h3>An initiative to identify, obtain, reformat, clean, document, publish and disseminate government datasets of public interest</h3>
          </div>
          <div class="product-main">
            <div class="product-actions">
              <a href="https://www.data-liberation-project.org/get-involved/" class="primary button">{% include 'lib/component/icon/plus.svg' %}Get involved</a>
              <a href="https://www.data-liberation-project.org/datasets/" class="primary ghost button">{% include 'lib/component/icon/search-octicon.svg' %}Search datasets</a>
              <a href="https://www.data-liberation-project.org/about/" class="primary ghost button">{% include 'lib/component/icon/book.svg' %}Learn how it works</a>
            </div>
            <div class="product-stats">
              <div class="stat">
                <span class="number">{{ product_stats.dataliberation.participants|intcomma }}</span>
                <span class="label">participants</span>
              </div>
              <!-- Holding this stat until we have the actual amount
              <div class="stat">
                <span class="number">140 GB</span>
                <span class="label">data liberated</span>
              </div>
              -->
              <div class="stat">
                <span class="number">{{ product_stats.dataliberation.datasets|intcomma }}</span>
                <span class="label">total datasets</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% newsletter %}
  <div class="tab-container" id="investigations">
    <header>
      <h3>Award-winning investigations and editorial collaborations</h3>
    </header>
    <ul class="tabs">
      {% for featured_project in featured_project_slots.all %}
      {% with project=featured_project.project %}
      <li class="tab {% if forloop.first %}active{% endif %}" data-tab="{{project.slug}}">{{project.title}}</li>
      {% endwith %}
      {% endfor %}
    </ul>
    <div class="tab-viewer">
      {% for featured_project in featured_project_slots.all %}
      {% with project=featured_project.project %}
      <div class="tab-content project {% if forloop.first %}active{% endif %}" data-tab="{{project.slug}}" id="{{project.slug}}">
        <div class="project-container">
          <div class="project-details">
            <a href="{{project.get_absolute_url}}"><img src="{% thumbnail project.image 1200x600 crop %}" alt="{{ project.name }} project image" class="project-image" /></a>
            <h4 class="project-title"><a href="{{project.get_absolute_url}}">{{ project.title }}<span class="arrow">&nbsp;&rarr;</span></a></h4>
            <p class="project-summary">{{ project.summary }}</p>
          </div>
          <div class="project-articles">
            <ul class="articles-list">
              {% for article in featured_project.articles.all|slice:4 %}
              <li class="article-item">
                <a href="{{ article.get_absolute_url }}" class="article-link">
                  <div class="article-text">
                    <h5 class="article-title">{{ article.title }}</h5>
                    <div class="article-meta">
                      <p class="article-date">{{ article.pub_date|date:"F j, Y" }}</p>
                      {% if article.authors.all %}
                      <p class="article-author">by {% for author in article.authors.all %}{{ author.profile.full_name }}{% if forloop.revcounter == 2 %} and {% elif not forloop.last %}, {% endif %}{% endfor %}</p>
                      {% endif %}
                    </div>
                  </div>
                </a>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      {% endwith %}
      {% endfor %}
    </div>
  </div>
  <div class="homepage-section" id="expertise">
    <header>
      <h3>Expert knowledge and community participation</h3>
    </header>
    <div class="expertise-grid">
      {% for section in expertise_sections %}
      <div class="expertise-item">
        <h4 class="expertise-item-title">{{ section.title }}</h4>
        <p class="expertise-item-subtitle">{{ section.subtitle }}</p>
        <p class="expertise-item-description">{{ section.description }}</p>
        <ul class="expertise-item-links">
          {% for link in section.links %}
          <li>
            <a href="{{ link.href }}" title="{{ link.title }}" class="primary ghost button"{% if link.target %} target="{{ link.target }}"{% endif %}>
              {% if link.icon %}{% include link.icon %}{% endif %}{{ link.text }}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock content %}
