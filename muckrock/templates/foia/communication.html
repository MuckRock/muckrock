{% load tags %}
{% load foia_tags %}

{% if communication %}
<section class="{% if not communication.response %}blue{% endif %} collapsable communication textbox {% if communication.autogenerated %}collapsed{% endif %}" id="{{ communication.anchor }}">
    <header class="textbox__header communication-header">
        <p class="from">From: {{ communication.from_line }}</p>
        <div class="actionables nocollapse">
            {% if foia_url %}
            <a href="#{{ communication.anchor }}" class="permalink">
            {% else %}
            <a href="{{communication.foia.get_absolute_url}}#{{communication.anchor}}" class="permalink">
            {% endif %}
                <time datetime="{{ communication.date|date:'c' }}" class="date">{{ communication.date | date:"m/d/Y" }}</time>
            </a>
            {% if not hide_options %}
            {% if request.user.is_staff %}
            <div class="options dropdown">
                <span class="dropdown-trigger">
                    {% include 'lib/component/icon/options.svg' %}
                </span>
                <ul class="options dropdown-list">
                    {% if comm.raw_emails %}<li><a href="{% url 'foia-raw' idx=comm.pk %}" class="option dropdown-list-item">Raw Email</a></li>{% endif %}
                    {% if comm.reverse_faxes.0.fax_id %}<li><a href="https://console.phaxio.com/viewFax?faxId={{comm.reverse_faxes.0.fax_id}}" class="option dropdown-list-item">Phaxio</a></li>{% endif %}
                    <li><a href="#status-{{comm.pk}}-form" class="option dropdown-list-item">Status</a></li>
                    <li><a href="#move-{{comm.pk}}-form" class="option dropdown-list-item">Move</a></li>
                    <li><a href="#resend-{{comm.pk}}-form" class="option dropdown-list-item">Resend</a></li>
                    <li><a href="#delete-{{comm.pk}}-form" class="option dropdown-list-item">Delete</a></li>
                </ul>
            </div>
            {% elif request.user.profile.is_advanced and comm.raw_emails %}
            <div class="options dropdown">
                <span class="dropdown-trigger">
                    {% include 'lib/component/icon/options.svg' %}
                </span>
                <ul class="options dropdown-list">
                    <li><a href="{% url 'foia-raw' idx=comm.pk %}" class="option">Raw Email</a></li>
                </ul>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </header>
    <section class="textbox__section communication-metadata">
    {% if communication.subject %}
        <p class="small subject">Subject: {{ communication.subject }}</p>
    {% else %}
        <p class="small subject">Subject: None</p>
    {% endif %}
    <span>
    {% if communication.status and request.user.is_staff %}
        <span class="small badge {{communication.status|classify_status}}">{{communication.get_status_display}}</span>
    {% endif %}
    {% if communication.get_delivered and request.user.is_staff %}
        <span class="small badge">{{communication.get_delivered|capfirst}}</span>
    {% endif %}
    </span>
    </section>
    {% if communication.communication %}
    <section class="textbox__section communication-body">
        {% if communication.full_html %}
        {{ communication.communication|redact_emails|safe }}
        {% else %}
        {{ communication.communication|redact_emails|urlize|linebreaks }}
        {% endif %}
    </section>
    {% endif %}
    {% if communication.files %}
    <ul class="files">
    {% with foia_url=communication.foia.get_absolute_url %}
    {% with files=communication.files.all|slice:":50" %}
    {% for file in files %}
        <li>{% include 'lib/file.html' with hide_id=True %}</li>
    {% endfor %}
    {% endwith %}
    {% endwith %}
    </ul>
    {% if communication.files.all|length > 50 %}
    <span class="notification warning">
        <span class="symbol">{% include 'lib/component/icon/warning.svg' %}</span>
        <span class="text">
            <p>There are too many files to display on this communication. <a class="action" href="{% url 'foia-files' jurisdiction=foia.jurisdiction.slug jidx=foia.jurisdiction.pk idx=foia.id slug=foia.slug %}">See all files</a></p>
        </span>
    </span>
    {% endif %}
    {% endif %}
    {% if request.user.is_staff %}
    <div class="communication-actions">
        <form method="post" class="status-communication communication-action" id="status-{{comm.pk}}-form">
            {% csrf_token %}
            <input type="hidden" name="comm_pk" value="{{comm.pk}}" />
            <label for="status">Change Communication Status</label>
            <select name="status">
            {% for choice in status_choices %}
                <option value="{{ choice|first }}" {% if choice|first == foia.status %}selected{% endif %}>{{ choice|last }}</option>
            {% endfor %}
            </select>
            <p class="help-text">This will only change the status of the communication, it will not effect the status of the request.</p>
            <button type="submit" name="action" value="status_comm" class="primary button">Change</button>
            <button class="cancel button" id="cancel-status-communication">Close</button>
        </form>
        <form method="post" class="move-communication communication-action" id="move-{{comm.pk}}-form">
            {% csrf_token %}
            <input type="hidden" name="comm_pk" value="{{comm.pk}}" />
            <label for="new_foia_pk">Move to Requests</label>
            <input type="text" name="new_foia_pks" value="{{ foia.pk }}" placeholder="Enter MuckRock number" />
            <button type="submit" name="action" value="move_comm" class="primary button">Move</button>
            <button class="cancel button" id="cancel-move-communication">Close</button>
        </form>
        <form method="post" class="resend-communication communication-action" id="resend-{{comm.pk}}-form">
            {% csrf_token %}
            <input type="hidden" name="comm_pk" value="{{comm.pk}}" />
            <label for="email">Resend to Email</label>
            <input
                id="id_email_or_fax"
                type="text"
                name="email_or_fax"
                {% if foia.email %}
                    value="{{foia.email.email}}"
                {% elif foia.fax %}
                    value="{{foia.fax.number.as_international}}"
                {% endif %}
                data-widget-bootstrap="text"
                data-autocomplete-choice-selector="[data-value]"
                data-autocomplete-minimum-characters="2"
                data-autocomplete-url="/autocomplete/EmailOrFaxAutocomplete/"
                maxlength="255"
                placeholder="Search emails and faxes"
                class="autocomplete-light-widget multiple autocomplete vTextField autocomplete-light-text-widget"
                >
            <p class="help-text">This will become the new email address for the request. Leave the field blank to force a manual mailing. For faxes, enter the 10 digit fax number beginning with a leading 1.</p>
            <button type="submit" name="action" value="resend_comm" class="primary button">Resend</button>
            <button class="cancel button" id="cancel-resend-communication">Close</button>
        </form>
        <form method="post" class="delete-communication communication-action" id="delete-{{comm.pk}}-form">
            {% csrf_token %}
            <input type="hidden" name="comm_pk" value="{{comm.pk}}" />
            <p>This will delete the communication. Are you sure you want to do this?</p>
            <button type="submit" name="action" value="delete_comm" class="failure button">Delete</button>
            <button class="cancel button" id="cancel-delete-communication">Close</button>
        </form>
    </div>
    {% endif %}
</section>
{% endif %}
