{% load tags %}
{% load foia_tags %}

{% if communication and not communication.hidden or request.user.is_staff %}
  <section class="{% if not communication.response %}blue{% endif %} collapsable communication textbox {% if communication.autogenerated %}collapsed{% endif %} {% if communication.hidden %}hidden{% endif %}" id="{{ communication.anchor }}">
    <header class="textbox__header communication-header">
      <p class="from">From: {{ communication.from_line }}</p>
      <div class="actionables nocollapse">
        {% if foia_url %}
          <a href="#{{ communication.anchor }}" class="permalink">
          {% else %}
            <a href="{{communication.foia.get_absolute_url}}#{{communication.anchor}}" class="permalink">
            {% endif %}
            {% with datetime=communication.get_subcomm.sent_datetime|default:communication.datetime %}
              <time datetime="{{ datetime|date:'c' }}" class="date">
                {{ datetime|date:"m/d/Y" }}
              </time>
            {% endwith %}
            </a>
            {% if not hide_options %}
              {% if request.user.is_staff %}
                <div class="options dropdown">
                  <span class="dropdown-trigger">
                    {% include 'lib/component/icon/options.svg' %}
                  </span>
                  <ul class="options dropdown-list">
                    {% if communication.raw_emails %}<li><a href="{% url 'foia-raw' idx=communication.pk %}" class="option dropdown-list-item">Raw Email</a></li>{% endif %}
                    {% if communication.reverse_faxes.0.fax_id %}<li><a href="https://console.phaxio.com/faxes/{{communication.reverse_faxes.0.fax_id}}" class="option dropdown-list-item">Phaxio</a></li>{% endif %}
                    {% if communication.mails.all.0.pdf %}<li><a href="{{ communication.mails.all.0.pdf.url }}" class="option dropdown-list-item">Mail PDF</a></li>{% endif %}
                    <li><a href="#status-{{communication.pk}}-form" class="option dropdown-list-item">Status</a></li>
                    <li><a href="#move-{{communication.pk}}-form" class="option dropdown-list-item">Move</a></li>
                    <li><a href="#resend-{{communication.pk}}-form" class="option dropdown-list-item">Resend</a></li>
                    <li><a href="#hide-{{communication.pk}}-form" class="option dropdown-list-item">{% if communication.hidden %}Unhide{% else %}Hide{% endif %}</a></li>
                    <li><a href="#upload-{{communication.pk}}-form" class="option dropdown-list-item">Upload File</a></li>
                  </ul>
                </div>
              {% elif request.user == communication.foia.user and communication.raw_emails %}
                <div class="options dropdown">
                  <span class="dropdown-trigger">
                    {% include 'lib/component/icon/options.svg' %}
                  </span>
                  <ul class="options dropdown-list">
                    <li><a href="{% url 'foia-raw' idx=communication.pk %}" class="option dropdown-list-item">Raw Email</a></li>
                  </ul>
                </div>
              {% endif %}
            {% endif %}
      </div>
    </header>
    {% if show_foia %}
      <section class="textbox__section communication-metadata">
        <p class="foia-backlink">
          Request:
          <a href="{{ communication.foia.get_absolute_url }}">
            {{ communication.foia }}
          </a>
        </p>
      </section>
    {% endif %}
    <section class="textbox__section communication-metadata">
      {% if communication.subject %}
        <p class="small subject">Subject: {{ communication.subject }}</p>
      {% else %}
        <p class="small subject">Subject: None</p>
      {% endif %}
      <span>
        {% if communication.status and request.user.is_staff %}
          <span class="small badge {{communication.status|classify_status}}">{{communication.get_status_display}}</span>
        {% endif %}
        {% if communication.get_delivered %}
          <span class="small badge">{{communication.get_delivered|capfirst}}</span>
        {% endif %}
      </span>
    </section>
    {% if communication.communication %}
      <section class="textbox__section communication-body">
        {% if communication.download %}
          {% include "foia/detail/file_download.html" %}
        {% endif %}
        {% if communication.full_html %}
          {{ communication.communication|redact_emails|safe }}
        {% else %}
          {{ communication.communication|redact_emails|urlize|linebreaks }}
        {% endif %}
      </section>
    {% endif %}
    {% if communication.display_files %}
      <ul class="files">
        {% with foia_url=communication.foia.get_absolute_url %}
          {% with files=communication.display_files|slice:":10" %}
            {% for file in files %}
              <li>{% include 'lib/file.html' with hide_id=True %}</li>
            {% endfor %}
          {% endwith %}
        {% endwith %}
      </ul>
      {% if communication.display_files|length > 10 %}
        <span class="notification warning">
          <span class="symbol">{% include 'lib/component/icon/warning.svg' %}</span>
          <span class="text">
            <p>There are too many files to display on this communication. <a class="action" href="{% url 'foia-files' jurisdiction=communication.foia.jurisdiction.slug jidx=communication.foia.jurisdiction.pk idx=communication.foia.id slug=communication.foia.slug %}">See all files</a></p>
          </span>
        </span>
      {% endif %}
    {% endif %}
    {% if request.user.is_staff and not hide_options %}
      <div class="communication-actions">
        <form method="post" class="status-communication communication-action" id="status-{{communication.pk}}-form">
          {% csrf_token %}
          <input type="hidden" name="comm_pk" value="{{communication.pk}}" />
          <label for="status">Change Communication Status</label>
          <select name="status">
            {% for choice in status_choices %}
              <option value="{{ choice|first }}" {% if choice|first == communication.foia.status %}selected{% endif %}>{{ choice|last }}</option>
            {% endfor %}
          </select>
          <p class="help-text">This will only change the status of the communication, it will not effect the status of the request.</p>
          <button type="submit" name="action" value="status_comm" class="primary button">Change</button>
          <button class="cancel button" id="cancel-status-communication">Close</button>
        </form>
        <form method="post" class="move-communication communication-action" id="move-{{communication.pk}}-form">
          {% csrf_token %}
          <input type="hidden" name="comm_pk" value="{{communication.pk}}" />
          <label for="new_foia_pk">Move to Requests</label>
          <input type="text" name="new_foia_pks" value="{{ communication.foia.pk }}" placeholder="Enter MuckRock number" />
          <button type="submit" name="action" value="move_comm" class="primary button">Move</button>
          <button class="cancel button" id="cancel-move-communication">Close</button>
        </form>
        <form method="post" class="resend-communication communication-action" id="resend-{{communication.pk}}-form">
          {% csrf_token %}
          <label>Resend Communication</label>
          {% with form=resend_forms|get_item:communication.pk %}
            {% for field in form %}
              {% if field.errors %}
                <span class="error field">{{field.errors}}</span>
              {% endif %}
              {% if field.name == "communication" %}
                <input type="hidden" id="id_{{ communication.pk }}-communication" name="{{ communication.pk }}-communication" value="{{ communication.pk }}">
                <input type="hidden" name="communication" value="{{ communication.pk }}">
              {% else %}
                {{ field }}
              {% endif %}
            {% endfor %}
          {% endwith %}
          <p class="help-text">This will become the new default for future outgoing communications.</p>
          <button type="submit" name="action" value="resend_comm" class="primary button">Resend</button>
          <button class="cancel button" id="cancel-resend-communication">Close</button>
        </form>
        <form method="post" class="hide-communication communication-action" id="hide-{{communication.pk}}-form">
          {% csrf_token %}
          <input type="hidden" name="comm_pk" value="{{communication.pk}}" />
          <p>This will {% if communication.hidden %}unhide{% else %}hide{% endif %} the communication. Are you sure you want to do this?</p>
          <button type="submit" name="action" value="hide_comm" class="failure button">{% if communication.hidden %}Unhide{% else %}Hide{% endif %}</button>
          <button class="cancel button" id="cancel-hide-communication">Close</button>
        </form>
        <form method="post" class="upload-communication communication-action" id="upload-{{communication.pk}}-form">
          {% csrf_token %}
          <p>Upload an attachment directly to this communication</p>
          <div class="fine-uploader-comm" data-comm-pk="{{communication.pk}}"></div>
        </form>
      </div>
    {% endif %}
  </section>
{% endif %}
